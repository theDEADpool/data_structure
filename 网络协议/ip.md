## 路由匹配规则
三个原则：  
1. 最长匹配原则，多条路径同时到达目标时，以其ip地址或网络号最长匹配作为最佳路由；  
2. 最小管理距离，不同的路由类型有不同的管理距离，比如直连路由是0、静态路由是1、EBGP路由是20、OSPF路由是110等，越小优先级越高；  
3. 度量值（metric值），即路由的开销，在上面两者都相同的情况下开销越小优先级越高；  

## 路由表&转发表&ARP表&Mac表
1. 路由表（rib）
去往其他网络的路径集合，通过route命令查询；  

2. 转发表（fib）
在路由表的基础上，选择出去往各网络地址的最优路径，组成一张新表称为转发表。通过route -F命令查询；  

3. 上述两张表都包括以下内容：  
a. destination，目的地址；  
b. gateway，网关，也就是下一跳；  
c. genmask，子网掩码，配合目的地址来确定目的网络的范围；  
d. Flag，标记，包括U（动态路由）、H（目标是一个主机）、G（路由指向网关）、D（由后台程序配置的路由）、R（恢复动态路由产生的路由）、M（由后台程序修改的路由）等；  
e. Metirc，开销值；  
f. Interface，出口，指导报文从哪个接口发出；  
g. Ref，引用次数，一般是0；  
h. Use，查询次数；  

4. ARP表  
ip和mac地址的对应关系，包括以下内容：  
a. address，目标ip地址；  
b. Hwtype，硬件类型；   
c. HwAddress，就是mac地址；  
d. Flag，标记位，C（通过ARP学习）M（通过arp -s命令配置）P（表示发布，用于ARP代理）
e. interface，本地接口；  
工作流程：  
a. 如果本地arp表查不到ip和mac的对应关系，由本机生产一个arp请求报文，请求报文的src ip和src mac是本机的ip和mac，dst ip是目标机器的ip，dst mac为0。以广播的方式发送该报文；  
b. 目标机器收到请求报文会匹配dst ip与本机ip，匹配成功之后会保存请求者的ip和mac地址到自己的ARP表中，然后通过单播方式将ARP应答发送给请求者，携带自身的mac地址；  
c. 请求者收到应答之后完成ARP学习，更新ARP表项并完成后续报文发送；  
d. 动态学习的ARP过期时间一般是10分钟，静态配置的没有过期时间；  
e. 静态ARP表项分为短静态ARP表项和长静态ARP表项，在配置长静态ARP表项时，除了配置IP地址和MAC地址项外，还必须配置该ARP表项所在VLAN和出接口。长静态ARP表项可以直接用于报文转发；在配置短静态ARP表项时，只需要配置IP地址和MAC地址项。如果出接口是三层以太网接口，短静态ARP表项可以直接用于报文转发；如果出接口是VLAN虚接口，短静态ARP表项不能直接用于报文转发，当要发送IP数据包时，先发送ARP请求报文，如果收到的响应报文中的源IP地址和源MAC地址与所配置的IP地址和MAC地址相同，则将接收ARP响应报文的接口加入该静态ARP表项中，之后就可以用于IP数据包的转发；  

ARP 主要攻击方式分为下面这几种
a. ARP泛洪攻击：通过向网关发送大量ARP报文，导致网关无法正常响应。首先发送大量的ARP请求报文，然后又发送大量虚假的ARP响应报文，从而造成网关部分的CPU利用率上升难以响应正常服务请求，而且网关还会被错误的ARP缓存表充满导致无法更新维护正常ARP缓存表，消耗网络带宽资源；  
b. ARP 欺骗主机攻击：攻击者通过ARP欺骗使得局域网内被攻击主机发送给网关的流量信息实际上都发送给攻击者。主机刷新自己的ARP使得在自己的ARP缓存表中对应的MAC为攻击者的MAC，这样一来其他用户要通过网关发送出去的数据流就会发往主机这里，这样就会造成用户的数据外泄;   
c. 欺骗网关的攻击: 欺骗网关就是把别的主机发送给网关的数据通过欺骗网关的形式使得这些数据通过网关发送给攻击者。这种攻击目标选择的不是个人主机而是局域网的网关，这样就会攻击者源源不断的获取局域网内其他用户韵数据．造成数据的泄露，同时用户电脑中病毒的概率也会提升;   
d. 中间人攻击: 中间人攻击是同时欺骗局域网内的主机和网关，局域网中用户的数据和网关的数据会发给同一个攻击者，用户与网关的数据就会泄露;   
e. IP地址冲突攻击: 通过对局域网中的物理主机进行扫描，扫描出局域网中的物理主机的 MAC 地址，然后根据物理主机的 MAC 进行攻击，导致局域网内的主机产生 IP 地址冲突，影响用户的网络正常使用;   

5. Mac表  
mac地址和物理接口对应关系，包括以下内容：  
a. mac地址：由 6 个字节组成。前 3 个字节表示厂商识别码，每个网卡厂商都有特定唯一的识别数字。后 3 个字节由厂商给每个网卡进行分配。厂商可以保证生产出来的网卡不会有相同 MAC 地址的网卡；  
b. 物理接口；  
c. 老化时间；  
d. mac条目类型（可能）；  
d. vlan id（可能）；  
mac表学习过程：
a. 初始状态mac为空，交换机发包的时候会将包发送给所有端口，这样每个端口的目标设备都会学习到本机的mac地址；  
b. 目标设备收到包后回复，交换机也就能学习到目标设备与本地端口之间的对应关系，不断重复这个过程，就能完成mac地址学习；  


## ip地址&ipv4&ipv6
网络地址：用来标识一个网络，平时所说的A\B\C\D类地址就是根据网络地址进行区分的。  
主机地址：用来标识网络中某一个具体的设备。  
子网掩码：作用就是将一个ip地址分成网络地址和主机地址两个部分。  

ip地址分类
特殊地址
0.0.0.0，表示本机  
255.255.255.255/32，受限的广播地址。局域网广播地址  
127.x.x.x，还回地址  
224.0.0.0/4，多播地址  

A类地址：  
1字节为网络地址，其他3个字节为主机地址。网络地址最高位必须是0。  
子网掩码255.0.0.0  
A类地址的范围：0.0.0.0 - 127.255.255.255  
除开上面说的特殊地址。A类地址中还有私有地址和保留地址  
10.0.0.0 - 10.255.255.255是私有地址，在局域网中使用的。  
0.0.0.0 - 0.255.255.255是保留地址。  

B类地址：  
第1和2字节为网络地址，后两个字节为主机地址，第一个字节前两位固定为10。  
B类地址范围：128.0.0.0 - 191.255.255.255  
子网掩码255.255.0.0    
私有地址172.16.0.0 - 172.31.255.255  
保留地址169.254.0.0 - 169.254.255.255  

C类地址：
第1、2、3字节为网络地址，第4个字节为主机地址，第一个字节的前三位固定为110。
C类地址范围：192.0.0.0 - 223.255.255.255
私有地址：192.168.0.0 - 192.168.255.255
子网掩码：255.255.255.0

D类地址：
不区分网络地址和主机地址。第一个字节的前四位固定为1110
D类地址范围：224.0.0.0 - 239.255.255.255
用于多播网络。

E类地址：
不缺分网络地址和主机地址。第一个字节取值范围11110-11111110 (240-254)
保留地址。

广播地址
主机地址所有位全1，即主机地址都是255的地址。
受限广播地址网络地址和主机地址全1即255.255.255.255，不会被路由器发送到外部网络，只是局域网内部广播。
直接网络地址就是正常的网络地址加主机地址全255的。会被路由器发送到对应的网络上的每台主机。

ipv6的地址长度是128位，ipv4的地址长度是32位。
常规表示方法为冒分十六进制。对于地址中间的连续的0，可以采用0位压缩，即以"::"表示一段连续的0。但"::"在地址中只能出现一次。
ipv4的地址转换为ipv6的地址::ffff:59.56.27.39，ipv4的地址放在最后32位，前面16位全为1，即0xffff，剩下的位全部都是0。
IN6_IS_ADDR_V4MAPPED，判断ipv6的地址是不是由ipv4的地址映射的。

ipv6和ipv4的区别
ipv4和ipv6报文头部中都有version、source address、destination address字段。

ipv4头部中有time to live字段，实际上是记录一个转发次数。一个ip包每经过一个路由器转发，这个数值就-1。当减为0的时候包就会被丢弃。
ipv6这个字段的名称变为Hop limit，作用是一样的。
ipv4头部的type of service服务类型字段。
ipv6改为traffic class。
ipv4头部的Protocol字段，表示ip包payload部分封装的协议类型。
ipv6改为Next Header。

ipv4头部在不考虑option的情况下，头部长度大小为20字节。用IHL字段来记录头部的总长度。Total Length记录整个IP包的长度。
ipv6头部没有options，头部长度固定为40字节。所以ipv6没有IHL字段。Total Length改成了Payload Length字段用来表示数据部分的长度。
ipv6头部没有ipv4中的checksum区域。ipv6正确性的校验是由上层协议完成的。
ipv6报文也不支持分片，每个ipv6网络的MTU都必须大于1280字节，ipv6的默认大小为1280字节。因此ipv6的头部也没有Identification, flags和fragment offset这三个字段，这三个字段都是ipv4为分片提供服务的。

ipv6新增了Flow label用来告诉路由器按照之前的路径发送报文，这样ip包就可以自动保持发出的顺序。但路由器本身不一定会遵守Flow label的要求。

ipv6与ipv4在编程上的区别
创建socket
6：socket(AF_INET6, SOCK_STREAM, IPPROTO_TCP);
4：socket(AF_INET, SOCK_STREAM, IPPROTO_TCP);
绑定地址
6：绑定地址的结构体struct sockaddr_in6，其中sin6_family字段赋值为PF_INET6。
4：绑定地址的结构体struct sockaddr_in，其中sin_family字段赋值为PF_INTET。

ipv4 checksum的算法
1、将ip首部中校验和字段设置为0
2、将ip首部每16位进行相加，如果结果超出了16位，就将高16位移动至低16位，然后相加。
3、将计算结果取反就是校验和。

接收方收到报文进行校验的时候，计算方法和发送方是一样的，但是比发送方多算了一个校验和的值，所以接收方计算出来的结果是全1。